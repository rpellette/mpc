<!DOCTYPE html>
<html>
<head>
	<title>MPC</title>
	<link href="./css/style.css" rel="stylesheet" type="text/css" />
	<!-- shim -->
	<script src="./inc/shim/Base64.js" type="text/javascript"></script>
	<script src="./inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="./inc/shim/WebAudioAPI.js" type="text/javascript"></script>
	<script src="./inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
	<!-- jasmid package -->
	<script src="./inc/jasmid/stream.js"></script>
	<script src="./inc/jasmid/midifile.js"></script>
	<script src="./inc/jasmid/replayer.js"></script>
	<!-- midi.js package -->
	<script src="./js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="./js/midi/gm.js" type="text/javascript"></script>
	<script src="./js/midi/loader.js" type="text/javascript"></script>
	<script src="./js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="./js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="./js/midi/plugin.webmidi.js" type="text/javascript"></script>
	<script src="./js/midi/player.js" type="text/javascript"></script>
	<!-- utils -->
	<script src="./js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="./js/util/dom_request_script.js" type="text/javascript"></script>
	<!-- includes -->
	<script src="./inc/timer.js" type="text/javascript"></script>
	<script src="./inc/event.js" type="text/javascript"></script>
</head>
<body onkeypress="keyPlay(event)">
	<div class="player"></div>
	<!--MPC -->
	<div class="w-container container">
        <div class="w-row skin">
            <div class="w-col w-col-2"></div>
            <div class="w-col w-col-6 w-clearfix column2">
                <div class="displaycase">
                    <div class="display">
                        <div class="displaytext" id="program">Program: Amen_Kit 
                            <br id="track">Track: A</div>
                    </div>
                </div>
                <div class="drumpad">
                    <div class="w-clearfix padbg">
                        <div class="padtitle">PAD 10</div>
                        <div class="padname">HAT</div>
                        <div class="pad" id="hat5" onclick="MIDI.noteOn(0, 60, 127, 0);MIDI.noteOff(0, 22, 0);"></div>
                    </div>
                </div>
                <div class="drumpad">
                    <div class="w-clearfix padbg">
                        <div class="padtitle">PAD 11</div>
                        <div class="padname">SNARE</div>
                        <div class="pad" id="snare1" onclick="MIDI.noteOn(0, 61, 127, 0);MIDI.noteOff(0, 23, 0);"></div>
                    </div>
                </div>
                <div class="drumpad">
                    <div class="w-clearfix padbg">
                        <div class="padtitle">PAD 12</div>
                        <div class="padname">SNARE</div>
                        <div class="pad" id="snare2" onclick="MIDI.noteOn(0, 62, 127, 0);MIDI.noteOff(0, 24, 0);"></div>
                    </div>
                </div>
                <div class="drumpad">
                    <div class="w-clearfix padbg">
                        <div class="padtitle">PAD 7</div>
                        <div class="padname">KICK</div>
                        <div class="pad" id="kick2" onclick="MIDI.noteOn(0, 56, 127, 0);MIDI.noteOff(0, 19, 0);"></div>
                    </div>
                </div>
                <div class="drumpad">
                    <div class="w-clearfix padbg">
                        <div class="padtitle">PAD 8</div>
                        <div class="padname">HAT</div>
                        <div class="pad" id="hat4" onclick="MIDI.noteOn(0, 57, 127, 0);MIDI.noteOff(0, 20, 0);"></div>
                    </div>
                </div>
                <div class="drumpad">
                    <div class="w-clearfix padbg">
                        <div class="padtitle">PAD 9</div>
                        <div class="padname">KICK</div>
                        <div class="pad" id="kick3" onclick="MIDI.noteOn(0, 58, 127, 0);MIDI.noteOff(0, 21, 0);"></div>
                    </div>
                </div>
                <div class="drumpad">
                    <div class="w-clearfix padbg">
                        <div class="padtitle">PAD 4</div>
                        <div class="padname">CHORD</div>
                        <div class="pad" id="chord" onclick="MIDI.noteOn(0, 52, 127, 0);MIDI.noteOff(0, 16, 0);"></div>
                    </div>
                </div>
                <div class="drumpad">
                    <div class="w-clearfix padbg">
                        <div class="padtitle">PAD 5</div>
                        <div class="padname">CRASH</div>
                        <div class="pad" id="crash" onclick="MIDI.noteOn(0, 53, 127, 0);MIDI.noteOff(0, 17, 0);"></div>
                    </div>
                </div>
                <div class="drumpad">
                    <div class="w-clearfix padbg">
                        <div class="padtitle">PAD 6</div>
                        <div class="padname">HAT</div>
                        <div class="pad" id="hat3" onclick="MIDI.noteOn(0, 54, 127, 0);MIDI.noteOff(0, 18, 0);"></div>
                    </div>
                </div>
                <div class="drumpad">
                    <div class="w-clearfix padbg">
                        <div class="padtitle">PAD 1</div>
                        <div class="padname">HAT</div>
                        <div class="pad" id="hat1" onclick="MIDI.noteOn(0, 48, 127, 0);MIDI.noteOff(0, 13, 0);"></div>
                    </div>
                </div>
                <div class="drumpad">
                    <div class="w-clearfix padbg">
                        <div class="padtitle">PAD 2</div>
                        <div class="padname">HAT</div>
                        <div class="pad" id="hat2" onclick="MIDI.noteOn(0, 49, 127, 0);MIDI.noteOff(0, 14, 0);"></div>
                    </div>
                </div>
                <div class="drumpad">
                    <div class="w-clearfix padbg">
                        <div class="padtitle">PAD 3</div>
                        <div class="padname">KICK</div>
                        <div class="pad" id="kick1" onclick="MIDI.noteOn(0, 50, 127, 0);MIDI.noteOff(0, 15, 0);"></div>
                    </div>
                </div>
            </div>
            <div class="w-col w-col-4 w-clearfix column3">
                <div class="bankdiv">
                    <div class="bankbg">
                        <div class="playbacktitle">A</div>
                        <div class="bankbtn"></div>
                    </div>
                </div>
                <div class="bankdiv">
                    <div class="bankbg">
                        <div class="playbacktitle">B</div>
                        <div class="bankbtn"></div>
                    </div>
                </div>
                <div class="bankdiv">
                    <div class="bankbg">
                        <div class="playbacktitle">C</div>
                        <div class="bankbtn"></div>
                    </div>
                </div>
                <div class="bankdiv">
                    <div class="bankbg">
                        <div class="playbacktitle">D</div>
                        <div class="bankbtn"></div>
                    </div>
                </div>
                <div class="playbackdiv">
                    <div class="w-clearfix bankbg">
                        <div class="led"></div>
                        <div class="playbacktitle">
                            <br>PREVIOUS</div>
                        <input type="image" src="./images/backward.png" class="playbackbtn" value="stop" onclick="player.getNextSong(-1);">
                    </div>
                </div>
                <div class="playbackdiv">
                    <div class="w-clearfix bankbg">
                        <div class="led"></div>
                        <div class="playbacktitle">
                            <br>PLAY</div>
                        <input type="image" src="./images/pause.png" class="playbackbtn" onclick="pausePlayStop()" id="pausePlayStop"></input>
                    </div>
                </div>
                <div class="playbackdiv">
                    <div class="w-clearfix bankbg">
                        <div class="led"></div>
                        <div class="playbacktitle">
                            <br>STOP</div>
                        <input type="image" src="./images/stop.png" class="playbackbtn" value="stop" onclick="pausePlayStop(true)">
                    </div>
                </div>
                <div class="playbackdiv">
                    <div class="w-clearfix bankbg">
                        <div class="led"></div>
                        <div class="playbacktitle">
                            <br>NEXT</div>
                        <input type="image" src="./images/forward.png" class="playbackbtn" value="stop" onclick="player.getNextSong(+1);">
                    </div>
                </div>
            </div>
        </div>
    </div>
<script type="text/javascript">
	function keyPlay(event){
		var keyInput = event.which || event.keyCode;
		var note = {97: 48, 119: 49, 115: 50, 101: 52, 100: 53, 102: 54, 116: 56, 103: 57, 121: 58, 104: 60, 117: 61, 106: 62};
		MIDI.noteOn(0, note[keyInput], 127, 0);
		setTimeout(function(){ MIDI.noteOff(0, note[keyInput], 0); }, 300);
		if (keyInput === 32) {
			pausePlayStop();
		}
		var noteMap = {97: "hat1", 119: "hat2", 115: "kick1", 101: "chord", 100: "crash", 102: "hat3", 116: "kick2", 103: "hat4", 121: "kick3", 104: "hat5", 117: "snare1", 106: "snare2"};
		var notePad = document.getElementById(noteMap[keyInput]);
		if (keyInput in noteMap){
	    	notePad.className = notePad.className + " active";
	    	setTimeout(function(){ notePad.className = "pad"; }, 100);
	    }
	};
	var pausePlayStop = function(stop) {
		var d = document.getElementById("pausePlayStop");
		if (stop) {
			MIDI.Player.stop();
			d.src = "./images/play.png";
		} else if (MIDI.Player.playing) {
			d.src = "./images/play.png";
			MIDI.Player.pause(true);
		} else {
			d.src = "./images/pause.png";
			MIDI.Player.resume();
		}
	};
	eventjs.add(window, "load", function(event) {
		var instrumentName = "synth_drum";
        //var instrumentName = "acoustic_grand_piano";
		MIDI.loader = new sketch.ui.Timer;
		MIDI.loadPlugin({
			soundfontUrl: "./soundfont/",
			instrument: instrumentName,
			onprogress: function(state, progress) {
				MIDI.loader.setValue(progress * 100);
			},
			onsuccess: function() {
				player = MIDI.Player;
				player.timeWarp = .6; 
				player.loadFile(song[songid++ % song.length], player.start);
				MIDI.programChange(0, MIDI.GM.byName[instrumentName].number);
				player.addListener(function(data) {
                    var msg = data.message;
					var note = data.note;
					var noteMap = {48: "hat1", 49: "hat2", 50: "kick1", 52: "chord", 53: "crash", 54: "hat3", 56: "kick2", 57: "hat4", 58: "kick3", 60: "hat5", 61: "snare1", 62: "snare2"};
                    var notePad = document.getElementById(noteMap[note]);
                    if(msg === 144) {
                        if(note){
                            notePad.className = notePad.className + " active";
                            console.log(note);
                        }
                    }
                    if(msg === 128) {
                        if(note){
                            notePad.className = "pad";
                        }
                    }
				});
				MIDIPlayerPercentage(player);
			}
		});
	});
	var MIDIPlayerPercentage = function(player) {
		var capsule = document.getElementById("capsule");
		eventjs.add(capsule, "drag", function(event, self) {
			eventjs.cancel(event);
			player.currentTime = (self.x) / 420 * player.endTime;
			if (player.currentTime < 0) player.currentTime = 0;
			if (player.currentTime > player.endTime) player.currentTime = player.endTime;
			if (self.state === "down") {
				player.pause(true);
			} else if (self.state === "up") {
				player.resume();
			}
		});
		function timeFormatting(n) {
			var minutes = n / 60 >> 0;
			var seconds = String(n - (minutes * 60) >> 0);
			if (seconds.length == 1) seconds = "0" + seconds;
			return minutes + ":" + seconds;
		};
		player.getNextSong = function(n) {
			var id = Math.abs((songid += n) % song.length);
			player.loadFile(song[id], player.start); 
		};
		player.setAnimation(function(data, element) {
			var percent = data.now / data.end;
			var now = data.now >> 0; 
			var end = data.end >> 0; 
			if (now === end) { 
				var id = ++songid % song.length;
				player.loadFile(song[id], player.start); 
			}
		});
	};
	var player;
	var songid = 0;
	var song = [
		//beat
		'data:audio/midi;base64,TVRoZAAAAAYAAAABAGBNVHJrAAAEDwD/AwcxIG1pZGkAAP9YBAQCJAgA/1gEBAIkCACQMnALgDIAKJAwWAqAMAAfkDZ2CIA2ACqQMnYKgDIAKZAxfgyAMQAgkDZUBoA2ACmQMmoKgDIAK5AwXAiAMAAnkDZ/B4A2ACqQMn8IgDIAJpAxbQ2AMQAhkDZ/B4A2ACuQMn8IgDIAKpAwVguAMAAEkDAMB4AwAB6QMn8GgDIAKpAwZwyAMAAkkDJ/B4AyACSQMFgOgDAAIZA2fgaANgArkDJ/CYAyACSQMX8NgDEAJZA2fgeANgArkDJ7CIAyACmQMGgOgDAAIZA2fwaANgArkDF1DIAxACGQNn8HgDYAKJAwVgqAMAAokDZ/B4A2ACeQMHQKgDAAKJA1fweANQAokDBQCoAwACqQMn8IgDIAK5Axfw2AMQAckDZ/BoA2ACuQMn8JgDIAKZAwYAuAMAAjkDZ/B4A2ACqQMn8JgDIAKZAxfw2AMQAjkDJ/CYAyACiQMGAJgDAALZAyfwmAMgAskDF/CoAxAAOQMGgKgDAAEJAxbASQMgoGgDEAAYAyACaQMHAKgDAAJJAyfwuAMgAikDBuCoAwACiQMn8JgDIAJpAwYwyAMAAhkDZ+B4A2ACmQMn8IgDIAKJAxfwyAMQAjkDZ/BoA2AC6QMnwIgDIAKJAwZguAMAAjkDZ/BoA2AC+QMnQHgDIAJ5AxfwqAMQAkkDZ+B4A2AC2QMn8JgDIAKpAwXAqAMAAjkDV/B4A1ACqQMHgIgDAAKJA6fwiAOgAqkDx/CYA8AB6QPn8GgD4AKZA6fweAOgApkD1wCIA9ACWQPn8GgD4ALJA6fAmAOgAqkDx6DoA8AB6QPn8GgD4ALZA8aQuAPAAgkD5/CIA+ACiQPG0JgDwAJJA+fwiAPgAlkDx/CoA8ACiQPn8HgD4AKpA+fwiAPgAlkDx4DIA8ACKQPn8JgD4AKJA+fwmAPgAqkDx1DIA8ACWQPn8IgD4AK5A8fwqAPAAmkD5/CIA+ACuQPHUKgDwAJZA+fwmAPgAqkDxwCIA8ACmQPn8HgD4AJ5A+fwqAPgAEkD1/B4A9ABmQNXIAkDEqB4AxAAGANQBkkDV/CYA1AGCQOn8AkD4YB4A+AAGAOgApkDx2C4A8AByQPn8HgD4AKZA6fwiAOgAkkD1mCIA9ACyQPn8HgD4AKpA6fwiAOgAqkDx0CIA8ACOQOn8HgDoAJ5A8egiAPAAlkDp/BoA6ACaQPG8JgDwAI5A6fweAOgAjkDxxCIA8ACWQOnkGgDoAKJA8ZwqAPAAokDp/B4A6ACeQPHoKgDwAIpA+fweAPgAokDp7BoA6ACSQPGUKgDwAI5A+fweAPgAskDpyB4A6ADSQPGYKgDwAI5A+XQKQOkQFgD4AAoA6AAD/LwA='		
	];
</script>
</body>
</html>